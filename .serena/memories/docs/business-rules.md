# Бизнес-правила — Столовая "Огромнов"

Последнее обновление: **28.02.2026**

## Основная модель

- **Корпоративная столовая** — еда готовится заранее (НЕТ поваров/кухни в процессе заказа)
- **Админ** — сотрудник столовой, собирает заказы из готовых блюд
- **Курьер** — доставщик, забирает собранный заказ и несёт по адресу
- **~200 человек** — целевая аудитория

## Роли

### Клиент (customer)
- Просматривает меню, добавляет в корзину
- Оформляет заказ с адресом доставки и временем
- Оплачивает картой, купоном или подпиской
- Видит историю заказов, может повторить
- Может добавлять блюда в избранное

### Админ (admin)
- Управляет заказами: видит оплаченные → нажимает "Готово" (ready)
- Может отменить заказ (до статуса delivering)
- Управляет меню: CRUD блюд, стоп-лист (available toggle)
- Управляет меню дня: выбирает блюда на сегодня
- Видит статистику (Phase 4)

### Курьер (delivery)
- Видит список готовых заказов (status=ready)
- Забирает заказ → статус `delivering`
- Доставляет → статус `delivered`
- Видит историю своих доставок за сегодня
- **Гибкое количество** — любой свободный курьер берёт заказ (FIFO)

## Определение роли
- **Один Telegram бот** для всех
- Роль хранится в `users.role` (default: 'customer')
- Роль задаётся вручную через SQL/админ-панель
- Клиентский Mini App открывается главной кнопкой бота
- Админский Mini App открывается командой `/admin` (бот проверяет роль)

## Переименования (утверждено)

### Талоны → Купоны
- В UI: "купон", "купона", "купонов"
- В TypeScript: `CouponType`, `CouponBalance`, `CouponPackage`, etc.
- В API URL: `/api/coupons/buy`, `/api/coupons/webhook`
- **В БД таблицы остаются**: `talons`, `talon_transactions` (маппинг в API слое)
- PaymentMethod: `'coupon'` (вместо `'talon'`)

### Кабинет → Адрес
- Доставка **по адресам** (улица, дом, квартира), НЕ по кабинетам офиса
- В TypeScript: `deliveryAddress` (вместо `deliveryRoom`)
- **В БД столбец остаётся**: `delivery_room` (SQL alias в API: `AS "deliveryAddress"`)
- Убрать `ROOM_SUGGESTIONS` (список кабинетов)
- Новый placeholder: "Улица, дом, квартира"
- Сохранять историю адресов для autocomplete

## Оплата

### Способы
1. **Картой** — T-Bank эквайринг, redirect на форму банка
2. **Купоном** — списание из баланса (1 купон = 1 заказ)
3. **Подпиской** — активная подписка покрывает заказ

### Покупка купонов
- Пакеты: 5, 10, 20 штук (с разными ценами)
- Оплата через T-Bank → webhook → зачисление на баланс

## Жизненный цикл заказа

```
1. Клиент оформляет заказ → pending
2. Оплата проходит → paid
3. Админ видит заказ, собирает → нажимает "Готово" → ready
4. Курьер берёт заказ → delivering
5. Курьер доставил → delivered
```

**Отмена**: админ может отменить на любом этапе до `delivering`.
**Нет `preparing`**: еда готова заранее, "приготовление" = сборка.

## Меню

### Категории (7)
daily, business-lunch, cold-snacks, first-courses, second-courses, sides, drinks

### Меню дня
- Каждый будний день cron (10:00 МСК) рассылает меню дня подписанным пользователям
- Админ выбирает какие блюда входят в меню дня (через AdminDailyMenuPage)
- Если меню дня пустое → фронтенд показывает первую непустую категорию

### Стоп-лист
- `menu_items.available = false` — блюдо временно недоступно
- Soft delete (не удаляем, чтобы сохранить историю заказов)

## Доставка
- По адресу (свободный текст, сохраняется для autocomplete)
- Время доставки: выбор из слотов (11:30, 12:00, 12:30, 13:00, 13:30, 14:00)
- Комментарий к заказу (необязательный, max 200 символов)
